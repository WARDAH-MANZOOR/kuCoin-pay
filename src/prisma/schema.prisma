generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Order {
  id                 String   @id @default(uuid())

  // REQUIRED (Create Order API)
  requestId          String   @unique
  orderAmount        Float
  orderCurrency      String
  goods              Json
  returnUrl          String
  cancelUrl          String
  source             String    // ANDROID / IOS / WEB

  // OPTIONAL (Create Order API)
  reference          String?
  subMerchantId      String?
  expireTime         Int?
  payRegion          String?    // NEW (optional)

  // INTERNAL (ALWAYS TRADE)
  orderType          String   @default("TRADE") // NEW (from webhook spec)

  // RESPONSE (From Create Order API)
  kucoinOrderId      String?  @unique
  qrcode             String?
  qrcodeUrl          String?
  appPayUrl          String?

  // WEBHOOK DATA
  status             String   @default("PENDING")
  payTime            BigInt?

  canRefundAmount    Float?
  refundCurrency     String?
  errorReason        String?
  payerUserId        String?
  retrieveKycStatus  Boolean?
  payerDetail        String?

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  refunds            Refund[]
}


model Refund {
  id                       String   @id @default(uuid())

  // MERCHANT SIDE â†’ Create Refund API
  refundRequestId         String   @unique       // merchant requestId
  payID                   String                // KuCoin original order ID
  refundAmount            Float
  refundReason            String?
  subMerchantId           String?
  reference               String?

  // KUCOIN â†’ refundId
  kucoinRefundId          String?  @unique      // refundId

  // KUCOIN SHARED FIELDS (webhook + query)
  merchantId              String?              // ðŸ”¥ NEW FIELD (KuCoin assigned)
  status                  String   @default("PENDING")
  refundCurrency          String?
  remainingRefundAmount   Float?
  remainingRefundCurrency String?
  refundFinishTime        BigInt?

  // ADVANCED (whitelisted merchant)
  payerUserId             String?
  retrieveKycStatus       Boolean?
  payerDetail             String?

  // ONCHAIN-REFUND ONLY
  assetUniqueId           String?
  chain                   String?
  feeAmount               Float?

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // RELATION TO ORDER
  order                   Order?   @relation(fields: [payID], references: [kucoinOrderId])
}



model Report {
  id          String   @id @default(uuid())
  reportType  String
  fileName    String?
  reportDate  String
  downloadUrl String?
  status      String
  createdAt   DateTime @default(now())

  @@unique([reportType, reportDate]) // âœ… Enforce uniqueness per report type and date
}

model Payout {
  id           String   @id @default(uuid())
  requestId    String   @unique                    // Merchantâ€™s payout request ID
  batchNo      String?                            // KuCoin Pay batch number
  payoutType   String                             // onChain or offChain
  batchName    String                             // Batch name
  currency     String                             // e.g., USDT
  chain        String?                            // e.g., TRON, ETH
  totalAmount  Float                              // Total payout amount
  totalCount   Int                                // Total number of payout details
  
  totalPaidAmount Float?
  processingFee   Float?
  totalPayoutFee  Float?

  status       String   @default("PENDING")       // SUCCESS / FAILED / PENDING
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // ðŸ‘‡ Relation: one payout â†’ many payout details
  details      PayoutDetail[]
}

model PayoutDetail {
  id              String   @id @default(uuid())
  detailId        String   @unique                // Merchantâ€™s detail identifier
  receiverUID     String?                         // KuCoin UID if off-chain
  receiverAddress String?                         // Wallet address if on-chain
  amount          Float
  remark          String?
  status          String   @default("PENDING")    // SUCCESS / FAILED / PENDING
  payoutId        String
  payoutFee       Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // ðŸ‘‡ Relation: each detail belongs to one payout
  payout          Payout   @relation(fields: [payoutId], references: [id])
}


model OnchainOrder {
  id              String   @id @default(uuid())
  requestId       String   @unique
  subMerchantId   String?                    // âœ… Added field
  fiatCurrency    String
  fiatAmount      Float
  cryptoCurrency  String
  cryptoAmount    Float
  chain           String
  reference       String?                    // âœ… Added field
  kucoinOrderId   String?  @unique
  walletAddress   String?
  precision       Int?
  expireTime      Int?

  assetUniqueId       String?
  paymentOrderType    String?
  paymentStatus       String?
  paymentCurrency     String?

  status          String   @default("PENDING")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
