generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Order {
  id                 String   @id @default(uuid())

  // REQUIRED (Create Order API)
  requestId          String   @unique
  orderAmount        Float
  orderCurrency      String
  goods              Json
  returnUrl          String
  cancelUrl          String
  source             String    // ANDROID / IOS / WEB

  // OPTIONAL (Create Order API)
  reference          String?
  subMerchantId      String?
  expireTime         Int?
  payRegion          String?    // NEW (optional)

  // INTERNAL (ALWAYS TRADE)
  orderType          String   @default("TRADE") // NEW (from webhook spec)

  // RESPONSE (From Create Order API)
  kucoinOrderId      String?  @unique
  qrcode             String?
  qrcodeUrl          String?
  appPayUrl          String?

  // WEBHOOK DATA
  status             String   @default("PENDING")
  payTime            BigInt?

  canRefundAmount    Float?
  refundCurrency     String?
  errorReason        String?
  payerUserId        String?
  retrieveKycStatus  Boolean?
  payerDetail        String?

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  refunds            Refund[]
}

model Refund {
  id                       String   @id @default(uuid())

  // MERCHANT SIDE → Create Refund API (normal refund)
  refundRequestId         String   @unique      
  payID                   String?               // normal refund
  payOrderId              String?               // onchain refund

  refundAmount            Float
  refundReason            String?
  subMerchantId           String?
  reference               String?

  // KUCOIN → refundId
  kucoinRefundId          String?  @unique      

  // KUCOIN SHARED FIELDS
  merchantId              String?
  status                  String   @default("PENDING")
  refundCurrency          String?
  remainingRefundAmount   Float?
  remainingRefundCurrency String?
  refundFinishTime        BigInt?

  // ADVANCED
  payerUserId             String?
  retrieveKycStatus       Boolean?
  payerDetail             String?

  // ONCHAIN REFUND ONLY
  assetUniqueId           String?
  chain                   String?
  feeAmount               Float?
  address                 String?     

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // RELATION
  order                   Order?   @relation(fields: [payOrderId], references: [kucoinOrderId])
}


model Report {
  id          String   @id @default(uuid())
  reportType  String
  fileName    String?
  reportDate  String
  downloadUrl String?
  status      String
  createdAt   DateTime @default(now())

  @@unique([reportType, reportDate]) // ✅ Enforce uniqueness per report type and date
}

model Payout {
  id              String   @id @default(uuid())
  requestId       String   @unique                    // Merchant’s payout request ID


  bizScene        String?                             // CRYPTO_REWARDS / SETTLEMENT / REIMBURSEMENT / etc.

  batchNo         String?                             // KuCoin batchNo (KuCoin Pay unique payout order ID )
  batchName       String                              // Merchant provided
  payoutType      String                              // onChain / offChain
  currency        String                              // USDT, BTC
  chain           String?                             // only for onChain

  totalAmount     Float
  totalCount      Int

  // KuCoin webhook/query return values
  totalPaidAmount Float?
  processingFee   Float?
  totalPayoutFee  Float?

  status          String   @default("PENDING")        // PROCESSING / SUCCEEDED_*
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  details         PayoutDetail[]
}

model PayoutDetail {
  id              String   @id @default(uuid())
  detailId        String   @unique                 // merchant detailId
  receiverUID     String?                          // offChain
  receiverAddress String?                          // onChain
  amount          Float
  remark          String?
  status          String   @default("PENDING")     // FAILED / SUCCEEDED
  payoutFee       Float?                           // webhook + query

  payoutId        String
  payout          Payout   @relation(fields: [payoutId], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}


model OnchainOrder {
  id                  String   @id @default(uuid())

  // MERCHANT FIELDS (Create API)
  requestId           String   @unique
  subMerchantId       String?
  fiatCurrency        String?
  fiatAmount          Float?
  cryptoCurrency      String
  cryptoAmount        Float?
  chain               String
  reference           String?
  goods               Json?

  // KUCOIN RESPONSE FIELDS (Create API)
  kucoinOrderId       String?   @unique
  walletAddress       String?
  precision           Int?
  expireTime          BigInt?   // number in ms

  // WEBHOOK FIELDS (Onchain Payment Notification)
  orderType           String?   // ALWAYS "ONCHAIN_PAYMENT"
  paymentOrderType    String?   // ACTIVE / PASSIVE
  paymentStatus       String?   // PART_PAYMENT / FULL_PAYMENT / OVER_PAYMENT / WRONG_PAYMENT

  assetUniqueId       String?   // Transaction hash
  paymentCurrency     String?   // actual payment currency
  paymentAmount       Float?    // actual payment amount
  paymentChain        String?   // actual chain used (btc, eth)

  status              String?   // status from webhook (CREATED, USER_PAY_COMPLETED, etc.)

  // REFUND RELATED (Query API)
  remainingRefundCurrency String?
  remainingRefundAmount   Float?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

